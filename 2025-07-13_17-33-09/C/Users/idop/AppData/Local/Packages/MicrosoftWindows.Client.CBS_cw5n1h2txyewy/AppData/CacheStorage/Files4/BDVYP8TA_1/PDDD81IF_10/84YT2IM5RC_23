var WSB;(function(n){const c=2,l=5,i=200,a=1.15,e=864e5,o="/msrewards/api/v1/getuserinfo",v="/msrewards/api/v1/codexeligible",y="https://account.microsoft.com/rewards?ref=WSB",p=n=>{return"https://account.microsoft.com/rewards/createuser?publ=CORTIP&crea=MY019H&pn=MULTIWSBACQ201910&returnUrl=%2Frewards%2Fredirect%3Flink%3D%252Frewards%26id%3Dbingtrial_250%26channel%3Dwsb%26type%3D16%26amount%3D"+n+"%26hash%3Db3bc83aeabe24a90fade4e7e81e00d5fda4aeb66abe9f569a27c5a97a75e8f57"},s="RewardsBadgeNotificationLastShownDate",u="RewardsBadgeNotificationTimesShown",w="&cvid=";class b{constructor(i){this._accessTokenManager=i;this._balance=new h;this._rewardsBadgeUpdatedHandlers=[];this._retryAttempted=0;r.init();t.init();const u=()=>{this._currentConversationId||(this._currentConversationId=n.Host.getConversationId(),this.isFeatureEnabled()&&this._msaAccount&&!n.Host.isAccountNotConsented(this._msaAccount)&&this.refreshBalance())};n.Host.bindConversationStart(()=>u());n.Host.bindQueryChangedOrInitialized(()=>u());n.Host.bindDismissed(()=>{this.clear(),this._msaAccount=null,this._currentConversationId=null,t.onDismiss(),n.RewardsFlyoutViewModel&&this.shouldShowRewardsFlyout()&&n.RewardsFlyoutViewModel.hideRewardsFlyout()});i.bindSelectedAccountChanged(t=>{if(this.isFeatureEnabled()&&!n.Host.isAccountNotConsented(t)){let n=t&&t.accountProviderAuthority=="consumers"?t:null;this.handleNewAccountAvailable(n)}});i.bindAccountTypesChanged(()=>{if(this.isFeatureEnabled()){let n=i.getCachedAccountInfo(0);this.handleNewAccountAvailable(n)}});i.bindAccessTokenAvailable((n,t)=>{if(n==0&&this.isFeatureEnabled())if(this._msaAccount)this.refreshBalance();else{let n=i.getCachedAccountInfo(0);this.handleNewAccountAvailable(n)}})}shouldShowBadgeNotification(){if(!this.shouldShowRewardsFlyout()||!n.config.rewardsFlyoutNotification||!this._userIsRewardsMember&&!n.config.rewardsFlyoutNotifNonMember)return!1;const t=Number(n.LightweightStorage.getItem(s))||0;if(this._userIsRewardsMember)return t==0||t+e<=n.getCurrentTime();const i=parseInt(n.LightweightStorage.getItem(u))||0,r=i<3,f=t==0||t+e*7<=n.getCurrentTime();return f&&r}onBadgeNotificationShown(){const t=parseInt(n.LightweightStorage.getItem(u))||0;n.LightweightStorage.setItem(s,n.getCurrentTime().toString());n.LightweightStorage.setItem(u,(t+1).toString());this.fireRewardsBadgeUpdated()}isFeatureEnabled(){return n.config.isRewardsEnabled?!0:n.contains(n.config.rewardsLanguageEnabled||[],n.uiLanguageCache.toLowerCase())}isCounterFactualLoggingEnabled(){return n.contains(n.config.rewardsCounterFactualLoggingLanguageEnabled||[],n.uiLanguageCache.toLowerCase())}handleNewAccountAvailable(n){const t=this._msaAccount;t!=n&&this._currentConversationId&&(this._msaAccount=n,this._msaAccount?t&&this._msaAccount.accountId==t.accountId||(this.clearCurrentBadge(),this.refreshBalance(null)):this.clearCurrentBadge())}clearCurrentBadge(){let n=this._balance.isSet();this.clear();n&&this.fireRewardsBadgeUpdated()}clear(){this._rewardsEnabled=!1;this._userIsRewardsMember=!0;this._userIsGiving=!1;this._fetchInProgress=!1;this._balance=new h;this._retryAttempted=0}updateUserCodexStatus(t){const i=!!t;if(n.Host.getIsCodexUser()!=i&&n.Host.setIsCodexUser(i),this._msaAccount){const t=`CodexStatus${this._msaAccount.accountId}`,r=n.LightweightStorage.getItem(t);if(r){const u=JSON.parse(r);u!=i&&n.LightweightStorage.setItem(t,JSON.stringify(i))}else n.LightweightStorage.setItem(t,JSON.stringify(i))}}refreshBalance(t){if(!this._fetchInProgress&&(!this._currentConversationId||this._userIsRewardsMember)){const e=this._currentConversationId,i=()=>e==this._currentConversationId,u=t=>{f.getBalanceAsyncToken(t,t=>{var u;if(n.config===null||n.config===void 0?void 0:n.config.enableAgeCheckCodex)try{this.updateUserCodexStatus(t===null||t===void 0?void 0:t.IsCodexUser)}catch(f){n.LogWSBError("UpdateUserCodexStatusFromRewardsAPI",`failed to update: ${f}`,undefined,undefined,undefined,"WindowsTelemetry")}this._fetchInProgress=!1;i()&&(t.IsRewardsUser||n.config.rewardsAnidAccrualEnabled)&&(this._rewardsEnabled=!0,this._userIsRewardsMember=t.IsRewardsUser,t.IsRewardsUser?(this._userIsGiving=t.IsGiveUser,typeof((u=SearchAppWrapper===null||SearchAppWrapper===void 0?void 0:SearchAppWrapper.CortanaApp)===null||u===void 0?void 0:u.textScaleFactor)!="undefined"&&SearchAppWrapper.CortanaApp.textScaleFactor<=a?this._overrideBalanceForSweepstakes=n.config.overrideRewardsBalanceText&&t.Promotions&&t.Promotions.some(n=>n.name==="BingFlyout_Layout_1MSweepstakes"):(this._overrideBalanceForSweepstakes=!1,n.InstrumentationHelper.logClientInstEvent("RewardsClientInst","HideSweepstakesOverrideText",null)),this.setNewBalance(t.Balance)):(this._userIsGiving=!1,this.setNewBalance(r.getBalance(this._msaAccount))))},n=>{this._fetchInProgress=!1,i()&&this.handleError(t,n)})};if(this._fetchInProgress=!0,t)u(t);else{const t=n.getBingResourceOrScope(0);this._accessTokenManager.getAccount(0,t,!1,!0,i=>{let r=i&&i.Token;r?u(r):((n.config===null||n.config===void 0?void 0:n.config.enableAgeCheckCodex)&&(t=="service::cortana.bing.com::mbi_ssl"||t=="077c9b95-2f57-4442-8872-134fcc08fcb3/Bing.MSA.Default")&&n.Host.getIsCodexUser()&&n.Host.setIsCodexUser(!1),this._fetchInProgress=!1)},undefined)}}}handleError(n,t){t&&t.Retryable&&this._retryAttempted<c&&(++this._retryAttempted,this.refreshBalance(n))}shouldShowRewardsFlyout(){const t=n.RuntimeConfig.QfMode===0||n.RuntimeConfig.QfMode===4||n.RuntimeConfig.QfMode===11;return n.config.rewFly&&!t&&n.RewardsFlyoutViewModel&&n.RewardsFlyoutViewModel.EnabledMarketAndRegion()&&(n.config.nonMemberRewFly||this._userIsRewardsMember)}hide(){n.RewardsFlyoutViewModel&&n.RewardsFlyoutViewModel.hideRewardsFlyout()}getDataModel(){if(!this._balance.isSet())return null;let r=this._balance.getValue(),u=this._userIsRewardsMember?this._userIsGiving?"RWBG":"RWBD":"RWBN",e;const f=this.shouldShowRewardsFlyout(),o=()=>{let n=this._userIsRewardsMember?y:p(r);return this.enrichUrlWithCvid(n)};e=f?()=>{this._flyout&&this._flyout.dismiss(),n.RewardsFlyoutViewModel&&n.RewardsFlyoutViewModel.toggleRewardsFlyout(()=>t.instrumentFlyoutClick(),(n,i)=>{t.instrumentClickOnBadge(u,n,i)}),this.shouldShowBadgeNotification()&&this.onBadgeNotificationShown()}:(i,r)=>{n.config.rewFly&&n.RewardsFlyoutViewModel&&!n.RewardsFlyoutViewModel.EnabledMarketAndRegion()&&t.instrumentRewardsFlyoutMarketBlock();t.instrumentClickOnBadge(u,i,r);const f=o();n.isServicingSearchBingAs3PEnabled()?n.Host.launchThirdPartyUriWithProtocolAsync(f.substring(f.indexOf(":")+1),"https"):n.Host.launchUriAsync(f)};let h=""+r,c=this._userIsRewardsMember?1:r/i,s=t.instrumentBadge(u);return s.setProperty("Balance",h),{counterFactualLoggingEnabled:this.isCounterFactualLoggingEnabled(),balance:r,userIsRewardsMember:this._userIsRewardsMember,userIsGiving:this._userIsGiving,click:e,instItem:s,badgeFillupPercentage:c,showNotification:this.shouldShowBadgeNotification(),showRewardsFlyout:f,dashboardUrl:f?"":o(),useRewardsBalanceTextOverride:this._overrideBalanceForSweepstakes}}enrichUrlWithCvid(t){return t+(w+n.encodeQueryParameter(n.Host.getConversationId()))}fireRewardsBadgeUpdated(){this._rewardsBadgeUpdatedHandlers.forEach(n=>n())}isRewardsEnabled(){return this.isCounterFactualLoggingEnabled()?!1:this._rewardsEnabled}notifyPointsRewarded(t){const i="notifyPointsRewarded";if(!this.isRewardsEnabled()){n.LogWSBError(i,null,new Error("Rewards not enabled"),undefined,undefined,"WindowsTelemetry");return}if(!this._userIsRewardsMember)if(t<=0)t=this._balance.getValue()+l;else{n.LogWSBError(i,""+t,new Error("Invalid non rewards member new balance"),undefined,undefined,"WindowsTelemetry");return}if(t<0){n.LogWSBError(i,""+t,new Error("Invalid rewards new balance"),undefined,undefined,"WindowsTelemetry");return}this.setNewBalance(t)}setNewBalance(n){this._userIsRewardsMember||(n>i&&(n=i),r.setNewBalance(this._msaAccount,n));this._balance.getValue()!=n&&(this._balance.setValue(n),this.fireRewardsBadgeUpdated())}bindRewardsBadgeUpdated(n,t){this._rewardsBadgeUpdatedHandlers.push(n);t&&this._balance.isSet()&&n()}}n.MicrosoftRewardsViewModel=b;class h{getValue(){return this._value}setValue(n){this._value=typeof n=="number"?n:undefined}isSet(){return typeof this._value=="number"}}let f;(function(t){function i(t,i,u,f){var e,o,s,h,c;if(i)if(i.RewardsUser){let t=i.Balance&&i.Balance.Available;if(typeof t=="number"){const f=i.UserProfileAttributes&&i.UserProfileAttributes.give_user&&i.UserProfileAttributes.give_user.toLowerCase()=="true";let r=!1;if((n.config===null||n.config===void 0?void 0:n.config.enableAgeCheckCodex)&&((e=i.UserProfileAttributes)===null||e===void 0?void 0:e.waitlistattributes)){const n=JSON.parse(i.UserProfileAttributes.waitlistattributes);r=((s=(o=n===null||n===void 0?void 0:n.propertyBag)===null||o===void 0?void 0:o.IsBlocked)===null||s===void 0?void 0:s.toLowerCase())!=="true"&&((c=(h=n===null||n===void 0?void 0:n.propertyBag)===null||h===void 0?void 0:h.IsAdultMSA)===null||c===void 0?void 0:c.toLowerCase())==="true"}u({IsRewardsUser:!0,Balance:t,IsGiveUser:f,IsCodexUser:r,Promotions:i.Promotions})}else f(i.ErrorDetail)}else if(i.ErrorDetail&&i.ErrorDetail.ErrorCode===5003)if(n.config.enableCodexEligibleJudgment){t||u({IsRewardsUser:!1});let i={};(n.VelocityKeys===null||n.VelocityKeys===void 0?void 0:n.VelocityKeys.isFeatureEnabled(55182095))&&n.config.enabledMsaAuthV2?i["X-Search-MsaV2Token"]=t:i["X-Search-RPSToken"]=t;i["X-Rewards-Country"]=n.Host.getRegion();let e=JSON.stringify({PartnerId:"WindowsSearchBox"});n.fetchUrlJson(v,i,e,n=>r(n,u,f))}else u({IsRewardsUser:!1});else f(i.ErrorDetail);else f(null)}function r(t,i,r){if(t)t.ErrorCode===0?t.CodexEligible&&t.CodexEligible.toLowerCase()==="true"?i({IsRewardsUser:!1,IsCodexUser:!0}):i({IsRewardsUser:!1,IsCodexUser:!1}):(n.LogWSBWarning("ProcessGetCodexeligibleRequestResponse",t.ErrorMessage,null,"BingTelemetry"),r({ErrorCode:t.ErrorCode,Message:t.ErrorMessage,Retryable:!1}));else n.LogWSBWarning("ProcessGetCodexeligibleRequestResponse","No response from Codexeligible api.",null,"BingTelemetry"),r(null)}function u(t,r,u){let e={};(n.VelocityKeys===null||n.VelocityKeys===void 0?void 0:n.VelocityKeys.isFeatureEnabled(55182095))&&n.config.enabledMsaAuthV2?e["X-Search-MsaV2Token"]=t:e["X-Search-RPSToken"]=t;const s=n.config.enableOfflineWithWeb&&n.config.webHost?n.config.webHost+o:o;n.fetchUrlJson(s,e,f(),n=>i(t,n,r,u))}function f(t){let r=n.config.overrideRewardsBalanceText?{FetchPromotions:!0}:{},i={PartnerId:"WSB",Channel:"WSB",Options:r};return t&&(i.UserId=t),JSON.stringify(i)}t.getBalanceAsyncToken=u})(f||(f={}));let r;(function(t){function f(){}function r(n){return"RewardsPoints_"+n.accountUserName}function u(t){let e=r(t),u=n.LightweightStorage.getItem(e),f=u?+u:0;return f>i?i:f}function e(t,f){if(f>i&&(f=i),u(t)!=f){let i=r(t);return f?n.LightweightStorage.setItem(i,""+f):n.LightweightStorage.removeItem(i),!0}return!1}t.init=f;t.getBalance=u;t.setNewBalance=e})(r||(r={}));let t;(function(t){function e(){}function o(){i=null;r=-1}function u(t){return i||(i=n.InstrumentedItem.getNonSuggestionInstrumentedItem(t,n.SyntheticQSCodesMaps.KValues,1)),i}function f(t){let i=n.SequenceNumberManager.getSequenceNumber(),f=u(t);return r<i&&(n.InstrumentationHelper.instrumentSyntheticInstrumentedItem(i,t,f),r=i),f}function s(t,i,e){let o=n.SequenceNumberManager.getSequenceNumber();r<o&&f(t);n.InstrumentationHelper.instrumentItemClick(i,u(t),o,null,e,null)}function h(){const t=n.SequenceNumberManager.getSequenceNumber();n.InstrumentationHelper.logClientInstEvent("Select","RewardsFlyoutOpen",t,null,"WindowsTelemetry",33554432)}function c(){const t=n.SequenceNumberManager.getSequenceNumber(),i={revIp:n.revIpRegionCache,language:n.getCurrentLanguage()};n.InstrumentationHelper.logClientInstEvent("Select","RewardsFlyoutMarketBlock",t,i,"WindowsTelemetry",16777216)}let i,r=-1;t.init=e;t.onDismiss=o;t.instrumentBadge=f;t.instrumentClickOnBadge=s;t.instrumentFlyoutClick=h;t.instrumentRewardsFlyoutMarketBlock=c})(t||(t={}))})(WSB||(WSB={}))