import os
from splunk.quarantine_files.configs import base_config, config_utils
from splunk.rest import splunk_web_requests

class EnableBadImports(base_config.Config):
    def __init__(self, session_key):
        base_config.Config.__init__(self, False)
        self.setting = "enable_unsupported_hotlinked_imports"
        quarantine_files_settings = splunk_web_requests.get_quarantine_files_settings(session_key)
        self.should_restrict = not quarantine_files_settings[self.setting]
    def get_paths_to_restrict(self, base_path):
        web_js_base_path = os.path.join(base_path, 'share', 'splunk', 'search_mrsparkle', 'exposed', 'js')
        all_candidate_files = config_utils.get_all_files_in_dir_recursive(web_js_base_path)
        exempt_from_move_dirs = [
            os.path.join(web_js_base_path, 'build', 'simplexml'),
            os.path.join(web_js_base_path, 'build', 'simplexml.min'),
            os.path.join(web_js_base_path, 'contrib', 'jquery'),
        ]
        exempt_from_move_file_paths = [
            os.path.join(web_js_base_path, 'contrib', 'jquery-2.1.0.js'),
            os.path.join(web_js_base_path, 'contrib', 'jquery-2.1.0.min.js'),
            os.path.join(web_js_base_path, 'contrib', 'jquery-1.8.2.js')
        ]
        if self.should_restrict:
            exempt_from_move_dirs += [
                os.path.join(web_js_base_path, 'contrib', 'leaflet', 'images'),
                os.path.join(web_js_base_path, 'contrib', 'ace-editor'),
                os.path.join(web_js_base_path, 'splunkjs', 'contrib', 'require-css'),
                os.path.join(web_js_base_path, 'contrib', 'moment', 'lang'),
                os.path.join(web_js_base_path, 'contrib', 'numeral', 'lang'),
                os.path.join(web_js_base_path, 'contrib', 'jquery.ui.datepicker'),
            ]
            exempt_from_move_file_paths += [
                os.path.join(web_js_base_path, 'i18n.js'),
                os.path.join(web_js_base_path, 'contrib', 'codemirror.js'),
                os.path.join(web_js_base_path, 'contrib', 'jquery.cookie.js'),
                os.path.join(web_js_base_path, 'contrib', 'lowpro_for_jquery.js'),
                os.path.join(web_js_base_path, 'etb.js'),
                os.path.join(web_js_base_path, 'splunk.jquery.csrf_protection.js'),
                os.path.join(web_js_base_path, 'common.min.js'),
                os.path.join(web_js_base_path, 'summarization.js'),
                os.path.join(web_js_base_path, 'contrib', 'jquery.treeview.js'),
                os.path.join(web_js_base_path, 'contrib', 'jquery.treeview.edit.js'),
                os.path.join(web_js_base_path, 'contrib', 'jquery.treeview.async.js'),
            ]
        for exempt_from_move_dir in exempt_from_move_dirs:
            exempt_from_move_file_paths += config_utils.get_all_files_in_dir_recursive(exempt_from_move_dir)
        paths_to_restrict = list(set(all_candidate_files) - set(exempt_from_move_file_paths))
        return paths_to_restrict
